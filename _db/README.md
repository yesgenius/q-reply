# Компонент работы с базой данных DuckDB для Q&A системы

## Описание
Модуль `db` предоставляет обёртку для работы с базой данных DuckDB, специализированную для хранения вопросов и ответов с векторными представлениями (эмбеддингами). Компонент позволяет сохранять пары вопрос-ответ, искать похожие вопросы по смысловой близости и управлять категориями.

## Основные возможности
- Хранение вопросов и ответов с их векторными представлениями
- Поиск похожих вопросов по косинусному сходству векторов
- Управление категориями вопросов
- Обновление существующих записей
- Удаление отсутствующих в актуальном списке записей
- Нормализация текста для единообразного хранения

## Требования
- Python 3.8+
- DuckDB 1.3.2
- NumPy 2.3.2

## Структура модуля
```
db/
├── __init__.py                  # Инициализация пакета
├── duckdb_qa_store.py          # Основной класс для работы с БД
├── duckdb_qa_store_test.py    # Тестовый скрипт с примерами использования
└── README.md                    # Документация
```

## API Reference

### Публичные переменные
- `DEFAULT_EMBEDDING_SIZE = 2560` - размер векторного представления по умолчанию
- `DEFAULT_SIMILARITY_THRESHOLD = 0.15` - минимальный порог сходства для поиска
- `DEFAULT_TOP_K = 5` - количество результатов поиска по умолчанию

### Публичные классы/функции

#### Класс `QADatabaseStore`

**Инициализация:**
```python
store = QADatabaseStore(db_path="storages/qa.duckdb", embedding_size=2560)
```

**Основные методы:**

- `insert_qa(question, answer, category, question_embedding, answer_embedding)` - добавить новую пару вопрос-ответ
- `find_question(question)` - найти точное совпадение вопроса
- `update_qa(question, answer, answer_embedding)` - обновить ответ для существующего вопроса
- `update_category(question, category)` - обновить категорию вопроса
- `search_similar_questions(question_embedding, category, top_k, threshold)` - поиск похожих вопросов
- `get_all_qa_records()` - получить все записи из БД
- `get_categories()` - получить список всех категорий
- `get_qa_without_category()` - получить вопросы без категории
- `delete_missing_records(current_questions)` - удалить записи, отсутствующие в списке
- `preprocess_text(text)` - нормализовать текст перед сохранением
- `close()` - закрыть соединение с БД

## Интеграция с другими компонентами

Модуль `db` используется в следующих скриптах системы Q-REPLY:

1. **update_db.py** - для синхронизации данных Excel с базой данных
2. **answer_generator.py** - для поиска похожих вопросов при формировании ответов

Модуль работает совместно с:
- **embeddings** - для получения векторных представлений текста
- **gigachat** - для взаимодействия с языковой моделью

## Тестовый запуск

Для проверки работоспособности модуля выполните:

```bash
python -m storages.duckdb_qa_store_test
```

Тестовый скрипт:
- Создаст временную БД
- Добавит тестовые вопросы и ответы
- Проверит все основные операции (поиск, обновление, удаление)
- Протестирует поиск по сходству с различными параметрами
- Удалит временную БД после завершения

При успешном выполнении вы увидите подробный лог всех операций и сообщение "All demo tests completed successfully."
