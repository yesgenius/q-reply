# GigaChat API Client

## Описание

Модуль для взаимодействия с GigaChat API — российской системой искусственного интеллекта от Сбера. Обеспечивает надёжную связь с сервисами генерации текста и создания векторных представлений (эмбеддингов).

## Назначение компонентов

### config.py
Управляет настройками подключения к GigaChat API. Автоматически загружает конфигурацию из файла `.env` или системных переменных окружения.

### client.py  
Основной модуль для работы с API. Выполняет запросы к GigaChat для:
- Генерации текстовых ответов (обычный и потоковый режим)
- Создания векторных представлений текста
- Получения списка доступных моделей
- Автоматического обновления токенов доступа

## Где используется

Модуль интегрирован в следующие компоненты системы:

- **Система эмбеддингов** (`embeddings/base_embedding.py`) — для преобразования текстов в векторные представления
- **Генераторы промптов** (`prompts/get_answer_prompt.py`, `prompts/get_category_prompt.py`, `prompts/get_judgement_prompt.py`) — для получения ответов от ИИ
- **Основные скрипты обработки** (`answer_generator.py`, `category_filler.py`, `judge_answer.py`) — через промпты и эмбеддинги

## Настройки

### Переменные окружения

Создайте файл `.env` в корне проекта или установите системные переменные:

#### Обязательные настройки аутентификации

Необходимо настроить **один из двух** способов:

**Вариант 1: Базовая аутентификация**
- `GIGACHAT_AUTH_BASIC` — токен авторизации в формате Base64

**Вариант 2: Сертификатная аутентификация (mTLS)**  
- `GIGACHAT_TLS_CERT` — путь к файлу сертификата клиента
- `GIGACHAT_TLS_KEY` — путь к файлу приватного ключа
- `GIGACHAT_TLS_CA_CERT` — путь к корневому сертификату (опционально)

#### Дополнительные настройки

- `GIGACHAT_SCOPE` — область доступа API
  - По умолчанию: `GIGACHAT_API_PERS`
  - Доступные значения: `GIGACHAT_API_PERS`, `GIGACHAT_API_B2B`, `GIGACHAT_API_CORP`

- `GIGACHAT_REQUEST_TIMEOUT` — таймаут обычных запросов в секундах
  - По умолчанию: `30`
  - Диапазон: от 1 до 300

- `GIGACHAT_STREAM_TIMEOUT` — таймаут потоковых запросов в секундах
  - По умолчанию: `300`
  - Диапазон: от 30 до 3600

- `GIGACHAT_MAX_RETRIES` — количество повторных попыток при ошибках
  - По умолчанию: `3`
  - Диапазон: от 0 до 10

- `GIGACHAT_OAUTH_URL` — адрес сервера OAuth токенов
  - По умолчанию: `https://ngw.devices.sberbank.ru:9443/api/v2/oauth`

- `GIGACHAT_COMPLETION_URL` — адрес сервера чат-комплишн
  - По умолчанию: `https://gigachat.devices.sberbank.ru/api/v1/chat/completions`

- `GIGACHAT_MODELS_URL` — адрес для получения списка моделей
  - По умолчанию: `https://gigachat.devices.sberbank.ru/api/v1/models`

- `GIGACHAT_EMBEDDINGS_URL` — адрес сервера эмбеддингов
  - По умолчанию: `https://gigachat.devices.sberbank.ru/api/v1/embeddings`

### Трассировочные заголовки

При вызове методов можно передавать опциональные параметры для трассировки:
- `x_request_id` — уникальный идентификатор запроса
- `x_session_id` — идентификатор сессии для связанных запросов
- `x_client_id` — идентификатор клиентского приложения

## Доступные модели

### Модели для чата

**Основные модели:**
- GigaChat — базовая модель (используется по умолчанию)
- GigaChat-2 — улучшенная версия
- GigaChat-Plus — расширенные возможности
- GigaChat-Pro — профессиональная версия
- GigaChat-Max — максимальные возможности
- GigaChat-2-Max — новейшая максимальная версия
- GigaChat-2-Pro — новейшая профессиональная версия

**Предварительные версии:**
- GigaChat-preview
- GigaChat-Plus-preview
- GigaChat-Pro-preview
- GigaChat-Max-preview

**Модели в контуре (специальное окружение):**
- Все основные модели также доступны в контуре
- Дополнительно: SaluteEmbeddings, SaluteEmbeddings_AB, SaluteV5Embeddings, SaluteV5Embeddings_AB

### Модели для эмбеддингов
- Embeddings — стандартная модель (используется по умолчанию в методе create_embeddings)
- Embeddings-2 — улучшенная версия
- EmbeddingsGigaR — специализированная модель с размерностью 2560 (используется в системе RAG)

## Дополнительные параметры генерации

При вызове метода `chat_completion` можно использовать следующие параметры:
- `temperature` — температура сэмплирования (больше 0)
- `top_p` — альтернатива температуре, ядерное сэмплирование (от 0 до 1)
- `max_tokens` — максимальное количество токенов в ответе
- `repetition_penalty` — штраф за повторения
- `functions` — описание доступных функций
- `function_call` — управление вызовом функций
- `attachments` — вложения к сообщению
- `update_interval` — интервал обновления для потоковой передачи
- `n` — количество вариантов ответа
- `stop` — последовательности для остановки генерации
- `presence_penalty` — штраф за присутствие токенов
- `frequency_penalty` — штраф за частоту токенов
- `logit_bias` — смещение вероятностей токенов
- `user` — идентификатор пользователя

## Запуск и тестирование

### Тестирование конфигурации

```bash
python -m gigachat.config
```

Команда проверит:
- Наличие файла `.env`
- Корректность загрузки переменных окружения
- Валидность настроек аутентификации
- Правильность всех параметров

### Тестирование клиента

```bash
python -m gigachat.client
```

Команда выполнит серию тестов:
1. Получение токена доступа (только для базовой аутентификации)
2. Запрос списка доступных моделей с трассировочными заголовками
3. Отправка тестового сообщения и получение ответа
4. Создание векторных представлений текста
5. Тестирование потоковой передачи данных

**Примечание:** Некоторые функции (эмбеддинги, потоковая передача) могут требовать оплаты и вернут ошибку 402 (Payment Required) для базовых тарифных планов.

## Использование клиента

### Базовый пример
```python
from gigachat import GigaChatClient

client = GigaChatClient()
# Используйте клиент для запросов
client.close()  # Важно закрыть сессию после использования
```

### С контекстным менеджером (рекомендуется)
```python
from gigachat import GigaChatClient

with GigaChatClient() as client:
    # Клиент автоматически закроется после выхода из блока
    pass
```

### Принудительное обновление токена
```python
token = client.get_access_token(force_refresh=True)
```

## Пример файла .env

```env
# Базовая аутентификация
GIGACHAT_AUTH_BASIC=ваш_токен_base64
GIGACHAT_SCOPE=GIGACHAT_API_PERS

# Или сертификатная аутентификация
# GIGACHAT_TLS_CERT=certs/client.crt
# GIGACHAT_TLS_KEY=certs/client.key
# GIGACHAT_SCOPE=GIGACHAT_API_CORP

# Опциональные настройки
GIGACHAT_REQUEST_TIMEOUT=45
GIGACHAT_STREAM_TIMEOUT=600
GIGACHAT_MAX_RETRIES=5
```

## Структура ответов

### Успешный запрос к моделям
Система вернёт список доступных моделей с их типами (`chat` или `embedder`).

### Успешная генерация текста
- **Обычный режим:** возвращается словарь с сгенерированным текстом и информацией об использованных токенах
- **Потоковый режим:** возвращается генератор, выдающий части ответа по мере их генерации

### Успешное создание эмбеддингов
Система вернёт векторные представления с указанием их размерности (например, 2560 для EmbeddingsGigaR).

## Режимы работы

Модуль автоматически определяет режим аутентификации:
- **mTLS режим** — при наличии сертификатов используется взаимная TLS-аутентификация без OAuth токенов
- **Basic режим** — при отсутствии сертификатов используется базовая аутентификация для получения OAuth токена

**Важно:** В обоих режимах SSL-верификация сертификатов сервера отключена.

## Важные особенности

- Модуль автоматически обрабатывает повторные попытки при временных сбоях (коды 429, 500, 502, 503, 504)
- Токены доступа обновляются автоматически за 60 секунд до истечения срока действия
- Поддерживается как обычная, так и потоковая передача ответов
- Все чувствительные данные (токены, ключи) маскируются в логах
- Сессия HTTP поддерживает connection pooling для оптимизации производительности
- При потоковой передаче соединение автоматически закрывается после завершения