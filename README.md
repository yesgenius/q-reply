# Q-Reply: Интеллектуальная система вопросов и ответов

Система для автоматической обработки вопросов на основе базы знаний с использованием искусственного интеллекта. Q-Reply помогает быстро находить ответы на новые вопросы, используя семантический поиск по существующим парам вопрос-ответ.

## Что умеет система

- **Создание базы знаний** — преобразует Excel-файлы с вопросами и ответами в векторную базу данных для быстрого поиска
- **Автоматическая категоризация** — распределяет вопросы по категориям с помощью искусственного интеллекта
- **Генерация ответов** — находит похожие вопросы в базе и формирует ответ на основе найденной информации
- **Оценка качества** — проверяет точность сгенерированных ответов, сравнивая их с эталонными
- **Экспорт данных** — выгружает содержимое базы знаний обратно в Excel для анализа

## Быстрый старт

1. Установите систему:
```bash
python setup.py
```

2. Активируйте виртуальное окружение:
   - **Windows (CMD)**: `.venv\Scripts\activate.bat`
   - **Windows (PowerShell)**: `.venv\Scripts\Activate.ps1`
   - **Linux/Mac**: `source .venv/bin/activate`

3. Создайте базу знаний из вашего файла с вопросами и ответами:
```bash
python db_update.py
```

4. Сгенерируйте ответы на новые вопросы:
```bash
python answer_generator.py
```

---

## Скрипты системы

### 1. Установка системы (`setup.py`)

**Назначение:** Автоматическая установка проекта — загружает файлы с GitHub, настраивает виртуальное окружение и устанавливает все необходимые библиотеки.

**Команда запуска:**
```bash
python setup.py
```

**Входные данные:**
- Интернет-соединение для загрузки файлов проекта

**Выходные данные:**
- Готовое к работе виртуальное окружение в папке `.venv`
- Все файлы проекта в текущей директории
- Открытая в браузере документация (README.md)

**Настройки:**
- `PROJECT_URL` — адрес архива проекта на GitHub (по умолчанию: основная ветка репозитория)
- `VENV_DIR` — имя папки для виртуального окружения (по умолчанию: `.venv`)

---

### 2. Создание и обновление базы знаний (`db_update.py`)

**Назначение:** Создает или обновляет векторную базу данных из Excel-файла с вопросами и ответами. Преобразует текст в числовые представления (эмбеддинги) для быстрого семантического поиска.

**Команда запуска:**
```bash
python db_update.py
```

**Входные данные:**
- **Файл:** `in/QA.xlsx`
- **Лист:** `QA` с колонками:
  - `A` (Category) — категория вопроса (может быть пустой)
  - `B` (Question) — текст вопроса (обязательно)
  - `C` (Answer) — текст ответа (обязательно)

**Выходные данные:**
- **База данных:** `storages/qa.duckdb` — векторная база для быстрого поиска
- **Файл с логами:** `out/QA_IMPORT_YYYY-MM-DD_HHMMSS.xlsx` — копия входного файла с дополнительными листами:
  - `LOG_DB` — детальная информация об обработке каждой строки
  - `LOG_DB_PARAMS` — все настройки скрипта и модели
- **Текстовый лог:** `out/QA_IMPORT_YYYY-MM-DD_HHMMSS.log` (если включено логирование в файл)

**Основные настройки:**

*Пути к файлам:*
- `INPUT_FILE` — путь к входному Excel-файлу (по умолчанию: `in/QA.xlsx`)
- `OUTPUT_DIR` — папка для результатов (по умолчанию: `out`)
- `DB_PATH` — путь к базе данных (по умолчанию: `storages/qa.duckdb`)

*Структура данных:*
- `SHEET_QA` — имя листа с данными (по умолчанию: `QA`)
- `COL_CATEGORY` — номер колонки с категорией (по умолчанию: `1` — колонка A)
- `COL_QUESTION` — номер колонки с вопросом (по умолчанию: `2` — колонка B)
- `COL_ANSWER` — номер колонки с ответом (по умолчанию: `3` — колонка C)
- `START_ROW` — первая строка с данными, пропуская заголовки (по умолчанию: `2`)

*Параметры эмбеддингов:*
- `EMBEDDING_SIZE` — размерность векторов для модели GigaChat (по умолчанию: `2560`)

*Логирование:*
- `LOG_DB` — создавать ли листы с детальными логами (по умолчанию: `True`)
- `LOG_TO_FILE` — сохранять ли текстовый файл с логами (по умолчанию: `True`)
- `LOG_LEVEL` — уровень детализации логов: `INFO` для обычной работы, `DEBUG` для отладки

*Сохранение прогресса:*
- `SAVE_FREQUENCY` — как часто сохранять промежуточные результаты, в количестве обработанных строк (по умолчанию: `5`)
- `RESUME_FILE` — файл для возобновления работы после прерывания (по умолчанию: `.update_db_resume.json`)

**Как работает скрипт:**

1. Читает вопросы и ответы из Excel-файла
2. Для каждого вопроса создает числовое представление (эмбеддинг)
3. Сохраняет данные в векторную базу DuckDB
4. При повторном запуске:
   - Обновляет изменившиеся ответы
   - Добавляет новые пары вопрос-ответ
   - Удаляет вопросы, которых больше нет в Excel

---

### 3. Категоризация вопросов (`category_filler.py`)

**Назначение:** Автоматически определяет категорию для каждого вопроса на основе списка доступных категорий. Использует искусственный интеллект для анализа содержания вопроса и присвоения наиболее подходящей категории.

**Команда запуска:**
```bash
python category_filler.py
```

**Входные данные:**
- **Файл:** `in/QA.xlsx`
- **Лист QA** с колонками:
  - `A` (Category) — колонка для категории (может быть пустой или неправильной)
  - `B` (Question) — текст вопроса (обязательно)
  - `C` (Answer) — текст ответа (опционально, но улучшает точность)
- **Лист CATEGORY** со списком доступных категорий:
  - `A` — название категории
  - `B` — описание категории

**Выходные данные:**
- **Файл:** `out/QA_YYYY-MM-DD_HHMMSS.xlsx` — копия входного файла с заполненными категориями и дополнительными листами:
  - `LOG_CATEGORY` — детальная информация о каждой категоризации (уверенность, обоснование)
  - `LOG_CATEGORY_PARAMS` — все настройки скрипта и модели
- **Текстовый лог:** `out/QA_YYYY-MM-DD_HHMMSS.log` (если включено логирование в файл)

**Основные настройки:**

*Пути к файлам:*
- `INPUT_FILE` — путь к Excel-файлу (по умолчанию: `in/QA.xlsx`)
- `OUTPUT_DIR` — папка для результатов (по умолчанию: `out`)

*Структура данных:*
- `SHEET_QA` — имя листа с вопросами (по умолчанию: `QA`)
- `SHEET_CATEGORY` — имя листа с категориями (по умолчанию: `CATEGORY`)
- `COL_CATEGORY_NAME` — номер колонки с названием категории в листе CATEGORY (по умолчанию: `1`)
- `COL_CATEGORY_DESC` — номер колонки с описанием категории в листе CATEGORY (по умолчанию: `2`)
- `COL_QA_CATEGORY` — номер колонки для категории в листе QA (по умолчанию: `1`)
- `COL_QA_QUESTION` — номер колонки с вопросом в листе QA (по умолчанию: `2`)
- `COL_QA_ANSWER` — номер колонки с ответом в листе QA (по умолчанию: `3`)

*Параметры категоризации:*
- `USE_ANSWER_FOR_CATEGORIZATION` — использовать ли ответ для более точного определения категории (по умолчанию: `True`)
- `MAX_RETRY_ATTEMPTS` — количество попыток при ошибке обращения к модели (по умолчанию: `5`)
- `RETRY_DELAY` — задержка между повторными попытками в секундах (по умолчанию: `2`)

*Логирование:*
- `LOG_CATEGORY` — создавать ли лист с детальными логами (по умолчанию: `True`)
- `LOG_TO_FILE` — сохранять ли текстовый файл с логами (по умолчанию: `True`)
- `LOG_LEVEL` — уровень детализации логов: `INFO` для обычной работы, `DEBUG` для отладки

*Сохранение прогресса:*
- `START_ROW` — первая строка с данными, пропуская заголовки (по умолчанию: `2`)
- `SAVE_FREQUENCY` — как часто сохранять промежуточные результаты, в строках (по умолчанию: `5`)
- `RESUME_FILE` — файл для возобновления работы (по умолчанию: `.category_filler_resume.json`)

**Как работает скрипт:**

1. Читает список категорий и их описания
2. Для каждого вопроса (и ответа, если включено) обращается к модели ИИ
3. Модель анализирует содержание и выбирает наиболее подходящую категорию
4. Записывает категорию в колонку A листа QA
5. Пропускает вопросы, у которых уже указана правильная категория

---

### 4. Генерация ответов (`answer_generator.py`)

**Назначение:** Генерирует ответы на новые вопросы, используя информацию из базы знаний. Находит похожие вопросы через семантический поиск и формирует ответ на основе найденной информации с помощью языковой модели.

**Команда запуска:**
```bash
python answer_generator.py
```

**Входные данные:**
- **Файл с вопросами:** `in/Q.xlsx`
  - **Лист Q:** вопросы для обработки в колонке A
  - **Лист T (опционально):** тема конференции в ячейке A2 для контекста
- **Файл с категориями (опционально):** `in/QA.xlsx`
  - **Лист CATEGORY:** список категорий для фильтрации поиска
- **База знаний:** `storages/qa.duckdb` — созданная скриптом `db_update.py`

**Выходные данные:**
- **Файл:** `out/Q_YYYY-MM-DD_HHMMSS.xlsx` — копия входного файла с ответами и дополнительными листами:
  - **Лист Q** дополнен колонками:
    - `B` (answer) — сгенерированный ответ
    - `C` (answer_confidence) — уверенность модели в ответе (0-100)
    - `D` (answer_sources_used) — список использованных источников из базы
    - `E` (answer_sources_reasoning) — обоснование выбора источников
    - `F, G, H` (s_1, q_1, a_1) — первый похожий вопрос: схожесть, вопрос, ответ
    - `I, J, K` (s_2, q_2, a_2) — второй похожий вопрос
    - `L, M, N` (s_3, q_3, a_3) — третий похожий вопрос
  - `LOG_ANSWER` — детальная информация о генерации каждого ответа
  - `LOG_ANSWER_PARAMS` — все настройки скрипта и моделей
- **Текстовый лог:** `out/Q_YYYY-MM-DD_HHMMSS.log` (если включено логирование в файл)

**Основные настройки:**

*Пути к файлам:*
- `INPUT_FILE_Q` — файл с вопросами (по умолчанию: `in/Q.xlsx`)
- `INPUT_FILE_QA` — файл с категориями (по умолчанию: `in/QA.xlsx`)
- `DATABASE_FILE` — путь к базе данных (по умолчанию: `storages/qa.duckdb`)
- `OUTPUT_DIR` — папка для результатов (по умолчанию: `out`)

*Структура данных:*
- `SHEET_Q` — имя листа с вопросами (по умолчанию: `Q`)
- `SHEET_T` — имя листа с темой конференции (по умолчанию: `T`)
- `SHEET_CATEGORY` — имя листа с категориями (по умолчанию: `CATEGORY`)
- `COL_Q_QUESTION` — номер колонки с вопросом (по умолчанию: `1`)
- `COL_Q_ANSWER` — номер колонки для ответа (по умолчанию: `2`)

*Параметры поиска:*
- `TOP_K_SIMILAR` — сколько похожих вопросов искать в базе (по умолчанию: `3`)
- `SIMILARITY_THRESHOLD` — минимальная схожесть для использования вопроса (по умолчанию: `0.8`, диапазон 0-1)
- `USE_CATEGORIES` — использовать ли категории для фильтрации поиска (по умолчанию: `False`)

*Режим контекста:*
- `USE_CHAT_HISTORY` — как передавать найденные Q&A модели:
  - `True` — как историю диалога (более естественно)
  - `False` — как пользовательский контекст (по умолчанию)

*Параметры эмбеддингов:*
- `EMBEDDING_MODEL` — модель для создания эмбеддингов (по умолчанию: `EmbeddingsGigaR`)
- `EMBEDDING_DIMENSION` — размерность векторов (по умолчанию: `2560`)

*Повторные попытки:*
- `MAX_RETRY_ATTEMPTS_CATEGORY` — попытки категоризации при ошибке (по умолчанию: `3`)
- `MAX_RETRY_ATTEMPTS_ANSWER` — попытки генерации ответа при ошибке (по умолчанию: `3`)
- `RETRY_DELAY` — задержка между попытками в секундах (по умолчанию: `2`)

*Логирование:*
- `LOG_ANSWER` — создавать ли листы с детальными логами (по умолчанию: `True`)
- `LOG_TO_FILE` — сохранять ли текстовый файл с логами (по умолчанию: `True`)
- `LOG_LEVEL` — уровень детализации: `INFO` для обычной работы, `DEBUG` для отладки

*Сохранение прогресса:*
- `START_ROW` — первая строка с данными (по умолчанию: `2`)
- `SAVE_FREQUENCY` — как часто сохранять результаты, в строках (по умолчанию: `5`)
- `RESUME_FILE` — файл для возобновления работы (по умолчанию: `.answer_generator_resume.json`)

**Как работает скрипт:**

1. Читает вопросы из файла Q.xlsx
2. Опционально определяет категорию каждого вопроса (если `USE_CATEGORIES=True`)
3. Ищет в базе данных похожие вопросы (с учетом категории, если включено)
4. Отбирает только те вопросы, схожесть которых выше порога `SIMILARITY_THRESHOLD`
5. Передает найденную информацию языковой модели для формирования ответа
6. Записывает ответ, уверенность и использованные источники в Excel

---

### 5. Оценка качества ответов (`judge_answer.py`)

**Назначение:** Оценивает качество сгенерированных ответов, сравнивая их с эталонными ответами из базы знаний. Вычисляет метрики точности, полноты, обнаруживает противоречия и галлюцинации.

**Команда запуска:**
```bash
python judge_answer.py
```

**Входные данные:**
- **Файл с кандидатами:** `in/QT.xlsx` — копия `Q.xlsx` после работы `answer_generator.py`
  - **Лист Q:** вопросы в колонке A, сгенерированные ответы в колонке B
- **Файл с эталонами:** `in/QA.xlsx`
  - **Лист QA:** эталонные вопросы в колонке B, эталонные ответы в колонке C

**Выходные данные:**
- **Файл:** `out/QT_YYYY-MM-DD_HHMMSS.xlsx` — копия входного файла с оценками:
  - **Лист Q** дополнен колонками справа:
    - `reference_question` — эталонный вопрос из базы
    - `reference_answer` — эталонный ответ из базы
    - `score` — итоговая оценка качества (0-100)
    - `class` — класс качества: `good` (≥85), `ok` (70-84), `bad` (<70)
    - `f1` — F1-метрика (гармоническое среднее точности и полноты)
    - `precision_c_to_r` — точность: доля информации из кандидата, присутствующей в эталоне
    - `recall_r_to_c` — полнота: доля информации из эталона, покрытой кандидатом
    - `contradiction` — обнаружено ли противоречие с эталоном
    - `hallucination` — содержит ли ответ информацию, отсутствующую в контексте
    - `justification` — текстовое обоснование оценки
    - `evidence` — конкретные примеры из текстов
    - `penalties` — примененные штрафы к оценке
  - `LOG_JUDGEMENT` — детальная информация о каждой оценке
  - `LOG_JUDGEMENT_PARAMS` — все настройки скрипта и модели
- **Текстовый лог:** `out/QT_YYYY-MM-DD_HHMMSS.log` с агрегированной статистикой:
  - Средняя оценка, медиана, стандартное отклонение
  - Доли классов good/ok/bad
  - Частота противоречий и галлюцинаций

**Основные настройки:**

*Пути к файлам:*
- `INPUT_FILE_QT` — файл с кандидатами для оценки (по умолчанию: `in/QT.xlsx`)
- `INPUT_FILE_QA` — файл с эталонными ответами (по умолчанию: `in/QA.xlsx`)
- `OUTPUT_DIR` — папка для результатов (по умолчанию: `out`)

*Структура данных:*
- `SHEET_Q` — имя листа с кандидатами (по умолчанию: `Q`)
- `SHEET_QA` — имя листа с эталонами (по умолчанию: `QA`)
- `COL_Q_QUESTION` — номер колонки с вопросом в QT (по умолчанию: `1`)
- `COL_Q_ANSWER` — номер колонки с ответом в QT (по умолчанию: `2`)
- `COL_QA_QUESTION` — номер колонки с вопросом в QA (по умолчанию: `2`)
- `COL_QA_ANSWER` — номер колонки с ответом в QA (по умолчанию: `3`)

*Повторные попытки:*
- `MAX_RETRY_ATTEMPTS_JUDGEMENT` — попытки оценки при ошибке (по умолчанию: `3`)
- `RETRY_DELAY` — задержка между попытками в секундах (по умолчанию: `2`)

*Логирование:*
- `LOG_JUDGEMENT` — создавать ли лист с детальными логами (по умолчанию: `True`)
- `LOG_TO_FILE` — сохранять ли текстовый файл с логами (по умолчанию: `True`)
- `LOG_LEVEL` — уровень детализации: `INFO` для обычной работы, `DEBUG` для отладки

*Сохранение прогресса:*
- `START_ROW` — первая строка с данными (по умолчанию: `2`)
- `SAVE_FREQUENCY` — как часто сохранять результаты, в строках (по умолчанию: `3`)
- `RESUME_FILE` — файл для возобновления работы (по умолчанию: `.judge_answer_resume.json`)

**Как работает скрипт:**

1. Читает кандидаты из QT.xlsx и эталоны из QA.xlsx
2. Сопоставляет ответы построчно (строка 2 в QT соответствует строке 2 в QA)
3. Для каждой пары обращается к модели оценки, которая:
   - Вычисляет точность (precision) и полноту (recall) через семантический анализ
   - Определяет F1-метрику как гармоническое среднее
   - Выявляет противоречия и галлюцинации
   - Применяет штрафы к итоговой оценке
   - Присваивает класс качества (good/ok/bad)
4. Записывает все метрики в Excel
5. Вычисляет агрегированную статистику по всем ответам

---

### 6. Экспорт базы знаний (`db_export.py`)

**Назначение:** Выгружает содержимое векторной базы данных обратно в Excel-файл. Полезно для анализа накопленных данных, создания резервных копий или передачи данных.

**Команда запуска:**
```bash
python db_export.py
```

**Входные данные:**
- **База данных:** `storages/qa.duckdb` — созданная скриптом `db_update.py`

**Выходные данные:**
- **Файл:** `out/QA_EXPORT_YYYY-MM-DD_HHMMSS.xlsx` с листами:
  - **QA** — все записи из базы с колонками:
    - `A` (Category) — категория
    - `B` (Question) — вопрос
    - `C` (Answer) — ответ
  - **EXPORT_INFO** — метаданные экспорта (дата, количество записей, параметры)
- **Текстовый лог:** `out/QA_EXPORT_YYYY-MM-DD_HHMMSS.log` (если включено логирование в файл)

**Основные настройки:**

*Пути к файлам:*
- `OUTPUT_DIR` — папка для результатов (по умолчанию: `out`)
- `DB_PATH` — путь к базе данных (по умолчанию: `storages/qa.duckdb`)

*Структура данных:*
- `SHEET_QA` — имя листа с данными (по умолчанию: `QA`)
- `SHEET_EXPORT_INFO` — имя листа с метаданными (по умолчанию: `EXPORT_INFO`)
- `COL_CATEGORY` — номер колонки для категории (по умолчанию: `1`)
- `COL_QUESTION` — номер колонки для вопроса (по умолчанию: `2`)
- `COL_ANSWER` — номер колонки для ответа (по умолчанию: `3`)

*Параметры экспорта:*
- `START_ROW` — первая строка для данных, после заголовков (по умолчанию: `2`)
- `INCLUDE_METADATA` — добавлять ли лист с информацией об экспорте (по умолчанию: `True`)

*Логирование:*
- `LOG_TO_FILE` — сохранять ли текстовый файл с логами (по умолчанию: `True`)
- `LOG_LEVEL` — уровень детализации: `INFO` для обычной работы, `DEBUG` для отладки

**Как работает скрипт:**

1. Открывает векторную базу данных
2. Извлекает все записи в исходном порядке
3. Записывает данные в Excel с форматированием
4. Добавляет лист с метаданными экспорта
5. Автоматически подбирает ширину колонок для удобства чтения

---

## Структура проекта

Подробное описание структуры проекта и всех компонентов доступно в документации:

📁 [Структура проекта](docs/PROJECT_STRUCTURE.md)

---

## Компоненты системы

Система состоит из независимых модулей, каждый из которых имеет свою документацию:

### Основные компоненты

- 🤖 [GigaChat API](gigachat/README.md) — интеграция с API GigaChat для работы с языковыми моделями и эмбеддингами
- 📚 [Хранилища данных](storages/README.md) — модули для работы с векторной базой DuckDB
- 🧠 [Эмбеддинги](embeddings/README.md) — создание числовых представлений текста через GigaChat
- 💬 [Промпты](prompts/README.md) — шаблоны для работы с языковыми моделями (категоризация, генерация ответов, оценка качества)
- 🛠️ [Утилиты](utils/README.md) — вспомогательные инструменты (логирование и другие)

---

## Требования

- **Python:** версия 3.12 или выше
- **Операционная система:** Windows, Linux или macOS
- **API-ключи:** для работы с GigaChat (настраиваются в модуле `gigachat`)
- **Excel:** для просмотра входных и выходных файлов

Все зависимости устанавливаются автоматически при запуске `setup.py`.

---

## Типичный рабочий процесс

1. **Подготовка данных** → Создайте `in/QA.xlsx` с вашими вопросами и ответами
2. **Создание базы** → Запустите `db_update.py` для создания векторной базы
3. **Категоризация** (опционально) → Запустите `category_filler.py` для автоматической категоризации
4. **Генерация ответов** → Создайте `in/Q.xlsx` с новыми вопросами и запустите `answer_generator.py`
5. **Оценка качества** (опционально) → Запустите `judge_answer.py` для проверки точности ответов
6. **Экспорт** (опционально) → Запустите `db_export.py` для выгрузки данных из базы

---

## Возобновление работы

Все основные скрипты (кроме `setup.py` и `db_export.py`) поддерживают автоматическое возобновление работы при прерывании. Просто запустите скрипт повторно — он продолжит с места остановки.

---

**Примечание:** Все настройки находятся в начале каждого скрипта в разделе `CONFIGURATION SECTION`. Вы можете изменить их перед запуском в соответствии с вашими требованиями.