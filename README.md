# Q-REPLY: Система автоматизации ответов на вопросы конференций

## Описание проекта

Q-REPLY — интеллектуальная система для автоматизации процесса подготовки ответов на вопросы участников конференций. Система использует RAG (Retrieval-Augmented Generation) подход с векторным поиском по базе исторических вопросов и ответов, обеспечивая консистентность и качество генерируемых ответов.

## Основные возможности

- **Автоматическая категоризация** вопросов по предопределенным категориям
- **Векторный поиск** похожих вопросов в базе данных DuckDB
- **Генерация ответов** с использованием контекста из исторических Q&A пар
- **Пакетная обработка** Excel файлов с вопросами
- **Возобновляемая обработка** при прерывании работы
- **Детальное логирование** всех этапов обработки

## Архитектура системы

```
q-reply/
├── gigachat/           # Клиент для работы с GigaChat API
├── embeddings/         # Создание векторных представлений текстов
├── db/                 # Работа с векторной базой данных DuckDB
├── prompts/            # Промпты для категоризации и генерации ответов
├── in/                 # Входные Excel файлы
├── out/                # Результаты обработки
├── certs/              # Сертификаты для mTLS (при необходимости)
├── category_filler.py  # Утилита категоризации вопросов
├── update_db.py        # Утилита обновления базы данных
├── answer_generator.py # Утилита генерации ответов
└── requirements.txt    # Зависимости проекта
```

## Компоненты системы

### [GigaChat API Client](gigachat/README.md)
Компонент для взаимодействия с API GigaChat — российской языковой модели от Сбера. Обеспечивает:
- Отправку сообщений и получение ответов
- Управление токенами доступа
- Поддержку Basic и mTLS аутентификации
- [Подробная документация →](gigachat/README.md)

### [Embeddings](embeddings/README.md)
Модуль создания векторных представлений текстов для семантического поиска:
- Поддержка различных режимов (документы, запросы, классификация)
- Батчевая обработка больших объемов
- Инструкции для улучшения качества поиска
- [Подробная документация →](embeddings/README.md)

### [Database Storage](db/README.md)
Векторная база данных на основе DuckDB для хранения и поиска Q&A пар:
- Косинусное сходство для поиска похожих вопросов
- Управление категориями
- Синхронизация с Excel
- [Подробная документация →](db/README.md)

### [Prompts](prompts/README.md)
Система управления промптами для языковой модели:
- Категоризация вопросов (`get_category_prompt`)
- Генерация ответов с контекстом (`get_answer_prompt`)
- Кэширование системных промптов
- [Подробная документация →](prompts/README.md)

## Установка

### Из архива GitHub

```bash
# Скачать и распаковать архив
wget https://github.com/yesgenius/q-reply/archive/refs/heads/main.zip
unzip main.zip
cd q-reply-main

# Установить зависимости
pip install -r requirements.txt

# Создать файл конфигурации из примера
cp .env.example .env

# Настроить учетные данные в .env
nano .env
```

### Клонирование репозитория

```bash
git clone https://github.com/yesgenius/q-reply.git
cd q-reply
pip install -r requirements.txt
cp .env.example .env
```

## Конфигурация

Создайте файл `.env` со следующими параметрами:

```bash
# Для базовой аутентификации
GIGACHAT_AUTH_BASIC=ваш_base64_токен

# ИЛИ для сертификатной аутентификации
GIGACHAT_TLS_CERT=./certs/tls.crt
GIGACHAT_TLS_KEY=./certs/tls.key
GIGACHAT_TLS_CA_CERT=./certs/ca.pem

# Выбор окружения (PERS для персонального, CORP для корпоративного)
GIGACHAT_SCOPE=GIGACHAT_API_PERS
```

Детали настройки GigaChat API описаны в [gigachat/README.md](gigachat/README.md#конфигурация).

## Сценарий использования

Система предполагает последовательное выполнение трех этапов обработки:

### 1. Категоризация вопросов (category_filler.py)

Первый этап — присвоение категорий историческим вопросам из базы знаний.

```bash
python category_filler.py
```

**Входные данные:**
- `in/QA.xlsx` с листами:
  - `CATEGORY` — справочник категорий (колонки A: название, B: описание)
  - `QA` — исторические вопросы и ответы (колонки A: категория, B: вопрос, C: ответ)

**Результат:**
- `out/QA_YYYY-MM-DD_HHMMSS.xlsx` — файл с заполненными категориями
- Лист `LOG_CATEGORY` с детальной информацией о процессе категоризации

Используемые компоненты: [prompts](prompts/README.md#get_category_promptpy), [gigachat](gigachat/README.md)

### 2. Обновление векторной базы данных (update_db.py)

Второй этап — синхронизация категоризированных Q&A пар с векторной базой данных.

```bash
python update_db.py
```

**Входные данные:**
- `in/QA.xlsx` (или результат из шага 1)

**Результат:**
- `qa.duckdb` — обновленная база данных с векторными представлениями
- `out/QA_YYYY-MM-DD_HHMMSS.xlsx` с листом `LOG_DB`

Используемые компоненты: [db](db/README.md), [embeddings](embeddings/README.md), [gigachat](gigachat/README.md)

### 3. Генерация ответов (answer_generator.py)

Третий этап — генерация ответов на новые вопросы на основе исторических данных.

```bash
python answer_generator.py
```

**Входные данные:**
- `in/Q.xlsx` с листами:
  - `Q` — новые вопросы для обработки (колонка A: вопрос)
  - `T` — опционально: тема конференции (ячейка A2)
- `in/QA.xlsx` — опционально: для использования категорий
- `qa.duckdb` — база данных из шага 2

**Результат:**
- `out/Q_YYYY-MM-DD_HHMMSS.xlsx` с ответами и похожими Q&A парами
- Лист `LOG_ANSWER` с детальной информацией о генерации

Используемые компоненты: все четыре ([db](db/README.md), [embeddings](embeddings/README.md), [prompts](prompts/README.md), [gigachat](gigachat/README.md))

## Структура LOG листов

### LOG_DB (в результатах update_db.py)

| Колонка | Описание |
|---------|----------|
| Вопрос | Исходный текст вопроса |
| input_text_q | Текст, отправленный на создание эмбеддинга вопроса |
| Ответ | Исходный текст ответа |
| input_text_a | Текст, отправленный на создание эмбеддинга ответа |

### LOG_CATEGORY (в результатах category_filler.py)

| Колонка | Описание |
|---------|----------|
| Категории | Исходная категория (если была) |
| Вопросы | Текст вопроса |
| category | Определенная системой категория |
| confidence | Уверенность в категории (0-1) |
| reasoning | Обоснование выбора категории |
| messages | JSON с историей взаимодействия с LLM |

### LOG_ANSWER (в результатах answer_generator.py)

| Колонка | Описание |
|---------|----------|
| Вопрос | Исходный вопрос |
| category | Определенная категория |
| category_confidence | Уверенность в категории |
| category_reasoning | Обоснование категории |
| category_messages | История определения категории |
| answer | Сгенерированный ответ |
| answer_confidence | Уверенность в ответе |
| answer_sources_used | Использованные источники |
| answer_messages | История генерации ответа |

## Возобновление прерванной обработки

Все утилиты поддерживают возобновление работы после прерывания:

- При прерывании (Ctrl+C) сохраняется текущий прогресс
- При повторном запуске обработка продолжается с последней сохраненной позиции
- Файлы состояния: `.category_filler_resume.json`, `.update_db_resume.json`, `.answer_generator_resume.json`

## Тестирование компонентов

Каждый компонент можно протестировать отдельно:

```bash
# Тестирование GigaChat клиента
python -m gigachat.client

# Тестирование создания эмбеддингов
python -m embeddings.base_embedding

# Тестирование работы с базой данных
python -m db.duckdb_qa_store_test

# Тестирование промптов
python -m prompts.get_category_prompt
python -m prompts.get_answer_prompt
```

Подробности о тестировании каждого компонента:
- [Тестирование GigaChat](gigachat/README.md#тестовый-запуск)
- [Тестирование Embeddings](embeddings/README.md#тестовый-запуск)
- [Тестирование Database](db/README.md#тестовый-запуск)
- [Тестирование Prompts](prompts/README.md#тестовый-запуск)

## Требования и спецификация

Полная техническая спецификация проекта доступна в [docs/Q-REPLY_REQ.md](docs/Q-REPLY_REQ.md)

## Зависимости
- Python 3.8+

Основные библиотеки (полный список в `requirements.txt`):
- `duckdb==1.3.2` — векторная база данных
- `openpyxl==3.1.5` — работа с Excel файлами
- `numpy==2.3.2` — операции с векторами
- `requests==2.32.4` — HTTP запросы к API
- `python-dotenv==1.1.1` — загрузка конфигурации

## Отладка и логирование

Уровень логирования настраивается в каждом скрипте через переменную `LOG_LEVEL`:
- `logging.DEBUG` — подробная отладочная информация
- `logging.INFO` — стандартный режим работы
- `logging.WARNING` — только предупреждения и ошибки

## Известные ограничения

- Максимальный размер батча для эмбеддингов: 100 текстов
- Размерность векторов: 2560 (модель EmbeddingsGigaR)
- Поддерживаемые форматы: только Excel (.xlsx)
- Минимальный порог сходства для поиска: 0.15

## При возникновении проблем

1. Проверьте правильность настройки `.env` файла
2. Убедитесь, что входные Excel файлы не открыты в других программах
3. Проверьте наличие всех необходимых листов и колонок в файлах
4. Изучите логи в консоли и LOG листах результирующих файлов
