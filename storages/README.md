# Хранилище вопросов и ответов DuckDB

## Что это?

Хранилище вопросов и ответов (Q&A Store) — это специальная база данных для хранения пар "вопрос-ответ" с возможностью интеллектуального поиска похожих вопросов. Система использует векторные представления текста для определения смысловой близости между вопросами.

## Основные возможности

- **Хранение вопросов и ответов** с сохранением оригинального форматирования
- **Категоризация** — группировка вопросов по темам
- **Умный поиск** — находит похожие по смыслу вопросы, даже если они сформулированы по-разному
- **Дедупликация** — автоматически предотвращает дублирование одинаковых вопросов
- **Валидация векторов** — проверка размерности и корректности векторных представлений
- **Массовые операции** — удаление записей, отсутствующих в новом списке, или полная очистка базы
- **Транзакционная безопасность** — все операции изменения выполняются в транзакциях с откатом при ошибках

## Где используется

Хранилище является ключевым компонентом RAG системы и используется в следующих модулях:

- **answer_generator.py** — для поиска похожих вопросов при генерации новых ответов
- **db_update.py** — для загрузки и обновления базы знаний из Excel файлов
- **db_export.py** — для выгрузки всей базы знаний в Excel формат

## Основные настройки

### При создании хранилища

- **Параметр**: `db_path`
  - **Описание**: Путь к файлу базы данных DuckDB
  - **Пример**: `"storages/qa.duckdb"`

- **Параметр**: `embedding_size`
  - **Значение по умолчанию**: 2560
  - **Описание**: Размерность векторов для представления текста. Должен совпадать с размерностью, используемой моделью эмбеддингов

### Настройки поиска

- **Параметр**: `threshold`
  - **Значение по умолчанию**: 0.5
  - **Описание**: Минимальная степень схожести (от 0 до 1) для включения вопроса в результаты поиска. Чем выше значение, тем более похожими должны быть вопросы

- **Параметр**: `top_k`
  - **Значение по умолчанию**: 5
  - **Описание**: Максимальное количество похожих вопросов, возвращаемых при поиске

## Структура хранения данных

Каждая запись в базе содержит:
- **Идентификатор** — уникальный номер записи
- **Вопрос** — оригинальный текст вопроса с сохранением форматирования
- **Нормализованный вопрос** — версия для поиска дубликатов и сравнения
- **Ответ** — текст ответа на вопрос
- **Категория** — тематическая группа (необязательно)
- **Векторное представление вопроса** — для поиска по схожести
- **Векторное представление ответа** — для дополнительного анализа
- **Дата создания** — когда запись была добавлена
- **Дата обновления** — когда запись была изменена последний раз

## Как работает нормализация текста

Система автоматически нормализует вопросы для корректного сравнения, но сохраняет оригинальную версию для отображения:

- Приводит текст к нижнему регистру
- Удаляет лишние пробелы
- Убирает знаки препинания (кроме важных для чисел, например: 49.8%, $3.99)
- Сохраняет оригинальное форматирование для отображения пользователю

Примеры нормализации:
- "Можно ли в 16 лет оформить кредитную карту?" → "можно ли в 16 лет оформить кредитную карту"
- "What's the BEST credit-card for 2025?!" → "whats the best creditcard for 2025"
- "Ставка 49.8% после льготного периода!" → "ставка 49.8% после льготного периода"

## Работа с категориями

Система поддерживает гибкую работу с категориями:
- Категории нечувствительны к регистру ("Banking" = "banking" = "BANKING")
- Можно искать вопросы только в определенной категории
- Поддерживаются вопросы без категории
- Можно получить список всех уникальных категорий
- Можно получить все записи без категории для последующей категоризации

## Валидация данных

Система автоматически проверяет корректность данных:
- **Векторы**: проверка размерности, отсутствие NaN/Inf значений, ненулевая норма
- **Текст**: автоматическая нормализация и очистка
- **Категории**: приведение к единому формату

## Тестирование

### Запуск полного набора тестов

```bash
python -m storages.duckdb_qa_store_test
```

### Что проверяется при тестировании

1. **Создание и инициализация базы данных**
2. **Вставка записей и предотвращение дубликатов**
3. **Поиск по точному совпадению вопроса**
4. **Сохранение оригинального форматирования текста**
5. **Обновление ответов и категорий**
6. **Поиск по схожести с различными параметрами**
   - Влияние порога схожести на количество результатов
   - Ограничение количества результатов (top_k)
   - Фильтрация по категориям
   - Сортировка по степени схожести
7. **Получение всех записей и категорий**
8. **Поиск записей без категории**
9. **Массовое удаление отсутствующих записей**
10. **Валидация размера векторных представлений**
11. **Работа с категориями без учета регистра**
12. **Дедупликация с разным форматированием**
13. **Обработка граничных случаев**
14. **Транзакционная целостность операций**
15. **Очистка всех записей**

## Управление соединением

База данных автоматически создает соединение при инициализации. После завершения работы рекомендуется закрывать соединение:

```python
db = QADatabaseStore("qa.duckdb")
# ... работа с базой ...
db.close()
```

## Логирование

Модуль использует централизованную систему логирования через `utils.logger`. Все операции записываются в лог с соответствующим уровнем:
- **INFO**: успешные операции, пропуск дубликатов
- **WARNING**: попытки обновления несуществующих записей
- **ERROR**: ошибки валидации, проблемы с базой данных

## Производительность и надежность

- База данных оптимизирована для работы с десятками тысяч записей
- Поиск по схожести выполняется непосредственно в SQL с использованием `array_cosine_similarity`
- Индексация по категориям ускоряет фильтрацию
- Дедупликация происходит автоматически при вставке
- Все операции изменения защищены транзакциями с автоматическим откатом при ошибках

## Требования

- Python 3.12 или выше
- DuckDB с поддержкой функции `array_cosine_similarity` (для поиска по схожести)
- NumPy для работы с векторами
- Модуль логирования из utils/logger.py

## Файлы модуля

- **duckdb_qa_store.py** — основной код хранилища
- **duckdb_qa_store_test.py** — тесты и примеры использования
- **qa.duckdb** — файл базы данных (путь задается при инициализации)

## Примеры использования

### Создание и инициализация

```python
from storages.duckdb_qa_store import QADatabaseStore

# Создание новой базы или подключение к существующей
db = QADatabaseStore("storages/qa.duckdb", embedding_size=2560)
```

### Добавление вопроса и ответа

```python
# Добавление с категорией
success = db.insert_qa(
    question="Можно ли оформить карту в 16 лет?",
    answer="Нет, только с 18 лет",
    category="Возрастные ограничения",
    question_embedding=[...],  # вектор размером 2560
    answer_embedding=[...]     # вектор размером 2560
)
```

### Поиск похожих вопросов

```python
# Поиск 3 наиболее похожих вопросов с порогом схожести 0.7
similar = db.search_similar_questions(
    question_embedding=[...],
    top_k=3,
    threshold=0.7,
    category="Возрастные ограничения"  # необязательный фильтр
)
```

### Работа с категориями

```python
# Получить все категории
categories = db.get_categories()

# Получить записи без категории
uncategorized = db.get_qa_without_category()
```

### Обслуживание базы

```python
# Удалить записи, которых нет в новом списке вопросов
deleted_count = db.delete_missing_records(["Вопрос 1", "Вопрос 2"])

# Полная очистка базы
db.clear_all_records()

# Закрытие соединения
db.close()
```