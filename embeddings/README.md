# Embeddings

## Описание
Компонент для создания векторных представлений (эмбеддингов) текстов с помощью GigaChat API. Преобразует тексты в числовые векторы для семантического поиска, классификации и анализа схожести текстов в системе Q-REPLY.

## Основные возможности
- Создание эмбеддингов для одиночных текстов и пакетов
- Поддержка инструкций для улучшения качества поиска
- Автоматическая обработка больших объемов данных батчами
- Различные режимы работы: документы, запросы, классификация, поиск ответов
- Детальное логирование процесса создания эмбеддингов

## Требования
- Python 3.8+
- Библиотека `gigachat` (обертка для GigaChat API)
- Настроенный клиент GigaChat с валидными учетными данными
- Доступ к моделям эмбеддингов (Embeddings или EmbeddingsGigaR)

## Структура модуля
```
embeddings/
├── __init__.py           # Инициализация пакета
├── base_embedding.py     # Основной модуль для создания эмбеддингов
└── README.md            # Документация
```

## API Reference

### Публичные переменные
- `DEFAULT_MODEL` — модель по умолчанию ("EmbeddingsGigaR")
- `llm` — инициализированный клиент GigaChat

### Публичные функции

#### `create_embeddings(texts, model, task_type, apply_instruction, custom_instruction, **kwargs)`
Основная функция для создания эмбеддингов.

**Параметры:**
- `texts` — текст или список текстов для обработки
- `model` — модель для создания эмбеддингов (по умолчанию "EmbeddingsGigaR")
- `task_type` — тип задачи ("document", "query", "similarity", "classification")
- `apply_instruction` — применять ли инструкцию (True/False)
- `custom_instruction` — пользовательская инструкция (опционально)

**Возвращает:** кортеж (список векторов, список обработанных текстов)

#### `create_batch_embeddings(texts, batch_size, model, task_type, **kwargs)`
Создание эмбеддингов для больших коллекций текстов.

**Параметры:**
- `texts` — список текстов
- `batch_size` — размер батча (по умолчанию 100)
- `model` — модель эмбеддингов
- `task_type` — тип задачи

**Возвращает:** кортеж (список всех векторов, список всех обработанных текстов)

#### `get_instruction(task_type, **kwargs)`
Генерация инструкции для улучшения качества эмбеддингов.

**Параметры:**
- `task_type` — тип задачи
- `**kwargs` — дополнительные параметры (например, категории для классификации)

**Возвращает:** строку с инструкцией или пустую строку

#### `prepare_texts(texts, instruction, **kwargs)`
Подготовка текстов с добавлением инструкций.

**Параметры:**
- `texts` — текст или список текстов
- `instruction` — инструкция для добавления

**Возвращает:** список подготовленных текстов

## Интеграция с другими компонентами

Модуль используется в:
- `update_db.py` — для создания эмбеддингов вопросов и ответов при обновлении базы данных
- `answer_generator.py` — для создания эмбеддингов новых вопросов при поиске похожих
- `db/duckdb_qa_store.py` — хранение и поиск по эмбеддингам в базе данных

## Тестовый запуск

Для проверки работы модуля выполните:

```bash
python -m embeddings.base_embedding
```

Будут проведены тесты:
1. Создание эмбеддинга для одного текста
2. Пакетная обработка нескольких текстов
3. Добавление инструкций для запросов
4. Использование пользовательских инструкций
5. Батчевая обработка больших объемов
6. Проверка валидации входных данных

Результаты тестирования будут выведены в консоль с индикацией успешности каждого теста.
