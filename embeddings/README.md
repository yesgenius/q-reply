# Компонент Embeddings

## Описание

Компонент **Embeddings** преобразует тексты в числовые векторы для поиска похожих вопросов и ответов в системе Q-Reply. Это позволяет находить семантически близкие тексты, даже если они используют разные слова для выражения одной мысли.

## Основное назначение

Модуль создает векторные представления текстов, которые затем используются для:
- Поиска похожих вопросов в базе знаний
- Сравнения текстов по смыслу
- Создания поисковых индексов в базе данных

## Структура компонента

### Модуль base_embedding.py

Основной модуль для работы с векторными представлениями текстов.

**Используется в:**
- `answer_generator.py` - для поиска похожих вопросов при генерации ответов
- `db_update.py` - для создания векторов при добавлении новых вопросов в базу данных

## Настройки

### Основные параметры

- **DEFAULT_MODEL** = "EmbeddingsGigaR"
  - Модель для создания векторных представлений с поддержкой инструкций
  
- **DEFAULT_MAX_RETRIES** = 3
  - Количество попыток при сбое API
  
- **DEFAULT_RETRY_DELAY** = 1.0
  - Базовая задержка между попытками (в секундах)

- **EMBEDDING_DIMENSION** = 2560
  - Размерность создаваемых векторов (используется в answer_generator.py)

### Типы задач

Модуль поддерживает различные типы обработки текстов:

- **document** - для индексации документов (без инструкций)
- **query** - для поисковых запросов
- **query_answer** - для поиска ответов по вопросам  
- **similarity** - для поиска похожих текстов
- **paraphrase** - для поиска перефразировок
- **classification** - для классификации по категориям

### Параметры для пакетной обработки

При обработке большого количества текстов:
- **batch_size** = 100 - количество текстов в одном запросе к API

### Дополнительные параметры

Модуль поддерживает параметры трассировки для отладки:
- **x_request_id** - идентификатор запроса
- **x_session_id** - идентификатор сессии
- **x_client_id** - идентификатор клиента

## Запуск и тестирование

### Запуск тестов модуля

Для проверки работоспособности модуля выполните:

```bash
python -m embeddings.base_embedding
```

### Что проверяют тесты

При запуске выполняются следующие проверки:

1. **Создание векторов для одного текста** - проверяет базовую функциональность
2. **Пакетная обработка нескольких текстов** - проверяет обработку списков
3. **Добавление инструкций для поиска** - проверяет корректность добавления префиксов
4. **Настройки повторных попыток** - проверяет устойчивость к сбоям
5. **Пакетная обработка с разбиением** - проверяет обработку больших объемов

### Результаты тестирования

После выполнения тестов вы увидите:
- ✅ PASSED - успешно пройденные тесты
- ❌ FAILED - проваленные тесты  
- ⚠️ SKIPPED - пропущенные тесты (при ошибке 402 - требуется оплата API)

В конце выводится раздел **TEST SUMMARY** с итоговой статистикой.

**Коды возврата:**
- 0 - все тесты пройдены успешно
- 1 - есть проваленные тесты

## Требования

### Обязательные компоненты

- Настроенный клиент GigaChat (см. основную документацию)
- Активные учетные данные для API в файле `.env`
- Python 3.12 или выше

### Зависимости внутри проекта

- `gigachat/client.py` - клиент для работы с API
- `utils/logger.py` - система логирования

## Интеграция с системой

### В процессе обновления базы (db_update.py)

Генерирует векторные представления для вопросов и ответов при добавлении в базу данных. Использует размерность векторов 2560.

### В процессе генерации ответов (answer_generator.py)

Использует векторы для поиска наиболее релевантных вопросов из базы знаний. Работает с той же размерностью векторов 2560.

## Примеры использования

### Простое создание векторов

```python
from embeddings.base_embedding import create_embeddings

# Для документа (без инструкции)
vectors, input_texts = create_embeddings(
    "Текст документа",
    task_type="document"
)

# Для поискового запроса (с инструкцией)
vectors, input_texts = create_embeddings(
    "Что такое Python?",
    task_type="query"
)
```

### Пакетная обработка

```python
from embeddings.base_embedding import create_batch_embeddings

texts = ["Текст 1", "Текст 2", "Текст 3"]
vectors, input_texts = create_batch_embeddings(
    texts,
    batch_size=100,
    task_type="document"
)
```

### Использование дополнительных параметров

```python
# С пользовательской инструкцией
vectors, input_texts = create_embeddings(
    "Текст для классификации",
    apply_instruction=True,
    custom_instruction="Классифицируй текст: "
)

# С параметрами трассировки
vectors, input_texts = create_embeddings(
    "Текст запроса",
    task_type="query",
    x_request_id="req-123",
    x_session_id="session-456"
)

# С настройками повторных попыток
vectors, input_texts = create_embeddings(
    "Важный текст",
    max_retries=5,
    retry_delay=2.0
)
```

## Логирование

Компонент автоматически записывает информацию о своей работе:
- INFO - основные операции и результаты
- DEBUG - детальная информация для отладки
- WARNING - предупреждения о потенциальных проблемах
- ERROR - критические ошибки

Логи помогают отслеживать процесс создания векторов и диагностировать проблемы.